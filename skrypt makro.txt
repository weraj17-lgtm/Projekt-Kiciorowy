Sub ZagregujDaneIUsunDuplikatyWKolumnieE()
    Dim ws As Worksheet
    Dim newWs As Worksheet
    Dim lastRow As Long
    Dim i As Long
    Dim dict As Object
    Dim key As String
    
    ' Utwórz obiekt słownika do przechowywania sum kwot i unikalnych danych w kolumnie C
    Set dict = CreateObject("Scripting.Dictionary")
    
    ' Ustaw arkusz, na którym chcesz działać
    Set ws = ThisWorkbook.Sheets("Arkusz1")
    
    ' Utwórz nowy arkusz
    Set newWs = ThisWorkbook.Sheets.Add
    newWs.Name = "Wynik"
    
    ' Znajdź ostatni wiersz w kolumnie R
    lastRow = ws.Cells(ws.Rows.Count, "R").End(xlUp).Row
    
    ' Przetwórz każdy wiersz w arkuszu, zaczynając od drugiego wiersza (pomijając nagłówek)
    For i = 2 To lastRow
        ' Kombinacja unikalnego identyfikatora z kolumn R, S i N
        key = Left(ws.Cells(i, "R").Value & Space(26), 26) & "|" & ws.Cells(i, "S").Value & "|" & ws.Cells(i, "N").Value
        
        ' Sprawdź, czy klucz istnieje w słowniku
        If dict.exists(key) Then
            ' Jeśli klucz istnieje, dodaj wartość z kolumny Q (suma kwot)
            dict(key) = dict(key) + ws.Cells(i, "Q").Value
            
            ' Dołącz dane z kolumny C tylko, jeśli są unikalne
            Dim eValue As String
            eValue = ws.Cells(i, "C").Text
            If InStr(1, dict(key & "_C"), eValue) = 0 Then
                dict(key & "_C") = dict(key & "_C") & ", " & eValue
            End If
        Else
            ' Jeśli klucz nie istnieje, dodaj go wraz z danymi z kolumny Q (suma kwot)
            dict.Add key, ws.Cells(i, "Q").Value
            
            ' Dodaj dane z kolumny C jako tekst (bez zmiany formatowania)
            dict(key & "_C") = "'" & ws.Cells(i, "C").Text
        End If
    Next i
    
    ' Wpisz wyniki zagregowanych danych na nowy arkusz z nowymi nazwami i kolejnością kolumn
    newWs.Cells(1, 1).Value = "Suma Kwoty"                             ' Kolumna Q
    newWs.Cells(1, 2).Value = "Beneficjent"                           ' Kolumna H + I
    newWs.Cells(1, 3).Value = "Nr Konta"                              ' Kolumna R
    newWs.Cells(1, 4).Value = "konto bankowe z którego idą płatności" ' Kolumna V
    newWs.Cells(1, 5).Value = "Opis nr fv"                            ' Kolumna C (zagregowane)
    newWs.Cells(1, 6).Value = ""                                      ' Pusta kolumna
    newWs.Cells(1, 7).Value = ""                                      ' Pusta kolumna
    newWs.Cells(1, 8).Value = "data realizacji"                       ' Kolumna W
    
    Dim newRow As Long
    newRow = 2
    
    ' Przetwórz dane i wpisz do nowego arkusza
    For i = 2 To lastRow
        key = Left(ws.Cells(i, "R").Value & Space(26), 26) & "|" & ws.Cells(i, "S").Value & "|" & ws.Cells(i, "N").Value
        
        If dict.exists(key) Then
            ' Suma Kwoty (kolumna Q)
            newWs.Cells(newRow, 1).Value = dict(key)
            
            ' Beneficjent (połączenie kolumn H i I)
            newWs.Cells(newRow, 2).Value = ws.Cells(i, "H").Value & " " & ws.Cells(i, "I").Value
            
            ' Nr Konta (kolumna R, formatowanie tekstowe 26 znaków)
            newWs.Cells(newRow, 3).NumberFormat = "@"
            newWs.Cells(newRow, 3).Value = "'" & ws.Cells(i, "R").Value
            
            ' Konto bankowe z którego idą płatności (kolumna V, formatowanie tekstowe 26 znaków)
            newWs.Cells(newRow, 4).NumberFormat = "@"
            newWs.Cells(newRow, 4).Value = "'" & ws.Cells(i, "V").Value
            
            ' Opis nr fv (zagregowane dane z kolumny C)
            newWs.Cells(newRow, 5).Value = dict(key & "_C")
            
            ' Puste kolumny
            newWs.Cells(newRow, 6).Value = ""
            newWs.Cells(newRow, 7).Value = ""
            
            ' Data realizacji (kolumna W)
            newWs.Cells(newRow, 8).Value = ws.Cells(i, "W").Value
            
            newRow = newRow + 1
            
            ' Usuń klucz z słownika, aby zachować tylko jeden zestaw danych
            dict.Remove key
        End If
    Next i
    
    ' Zwolnij pamięć
    Set dict = Nothing
    
    MsgBox "Zagregowanie danych, usunięcie duplikatów i zachowanie formatowania numerów kont zostało zakończone."
End Sub
